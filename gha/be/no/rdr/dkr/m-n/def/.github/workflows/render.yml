name: Frontend on Render with Docker

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}
      USERNAME: ${{ secrets.DOCKER_USERNAME || github.actor }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build Image with Testing
        run: docker build -t ${{ vars.NAME }}:test-tag .

      - name: Generate Image Name
        if: github.event_name == 'push'
        run: |
          RAW_IMAGE="${{ env.REGISTRY }}/${{ env.USERNAME }}/${{ vars.NAME }}"
          echo "IMAGE=$(echo $RAW_IMAGE | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      - name: Login to Docker
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN || secrets.GITHUB_TOKEN }}
      - name: Tag and Push Production Image
        if: github.event_name == 'push'
        run: |
          SHA=${{ github.sha }}
          docker tag ${{ vars.NAME }}:test-tag ${{ env.IMAGE }}:${SHA}
          docker tag ${{ vars.NAME }}:test-tag ${{ env.IMAGE }}:latest
          docker push ${{ env.IMAGE }}:${SHA}
          docker push ${{ env.IMAGE }}:latest
      - name: Check Current Image
        id: check_image
        if: github.event_name == 'push'
        run: |
          IMAGE=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}" | \
            jq -r '.imagePath // ""')
          if [[ "$IMAGE" == *"alpine"* ]] || [[ -z "$IMAGE" ]]; then
            echo "needs_patch=true" >> $GITHUB_OUTPUT
          else
            echo "needs_patch=false" >> $GITHUB_OUTPUT
          fi
      - name: Patch Service on Render
        if: github.event_name == 'push' && steps.check_image.outputs.needs_patch == 'true'
        run: |
          curl -X PATCH https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }} \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "image": {
              "ownerId": "${{ secrets.RENDER_OWNER_ID }}",
              "imagePath": "${{ env.IMAGE }}:latest",
              "registryCredentialId": "${{ secrets.RENDER_CRED_ID }}"
            }
          }'
      - name: Trigger Deployment on Render
        if: github.event_name == 'push'
        run: |
          curl -X POST https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"
